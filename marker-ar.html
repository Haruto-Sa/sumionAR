<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AR.js を使った Hiro マーカー + GLB 3モデル デモ">
    <title>Hiro マーカー AR (Duck / Suimon / Wankosoba)</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- AR.jsとA-Frame（バージョン固定） -->
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://rawcdn.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    
    <!-- 戻るボタン -->
    <button class="back-button" onclick="goBack()">← ホーム</button>
    
    <!-- スタートオーバーレイ（モバイルのカメラ起動安定化のため） -->
    <div id="start-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:2000;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff;text-align:center;padding:20px;">
        <h2 style="margin-bottom:12px;">カメラの起動準備</h2>
        <p style="opacity:0.9;margin-bottom:20px;">「開始」をタップしてカメラを起動してください。</p>
        <button id="start-btn" style="background:#667eea;border:none;color:#fff;padding:12px 24px;border-radius:9999px;font-weight:bold;cursor:pointer;">開始</button>
        <p style="font-size:12px;opacity:0.8;margin-top:14px;">カメラアクセスの許可ダイアログが表示される場合があります。</p>
    </div>

    <!-- 情報オーバーレイ -->
    <div class="info-overlay">
        <p>カメラで Hiro マーカーをスキャンしてください</p>
    </div>

    <!-- モデル切り替え UI -->
    <div id="model-switcher" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:1500;display:flex;gap:8px;background:rgba(0,0,0,0.6);padding:8px 14px;border-radius:999px;font-size:13px;">
        <button data-model="duck"  style="border:none;border-radius:999px;padding:6px 10px;background:#ffffff;color:#333;cursor:pointer;font-weight:bold;">Duck</button>
        <button data-model="suimon" style="border:none;border-radius:999px;padding:6px 10px;background:#2ecc71;color:#fff;cursor:pointer;font-weight:bold;">Suimon</button>
        <button data-model="wanko" style="border:none;border-radius:999px;padding:6px 10px;background:#e67e22;color:#fff;cursor:pointer;font-weight:bold;">Wankosoba</button>
    </div>

    <!-- A-Frame ARシーン -->
    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
    >
        <!-- アセット管理（Vite の public/assets 配下の GLB を参照） -->
        <a-assets>
            <a-asset-item id="duck-model" src="/assets/Duck.glb"></a-asset-item>
            <a-asset-item id="suimon-model" src="/assets/suimon-kousin.glb"></a-asset-item>
            <a-asset-item id="wanko-model" src="/assets/wankosoba.glb"></a-asset-item>
        </a-assets>

        <!-- マーカー: Hiro -->
        <a-marker preset="hiro">
            <!-- 3Dモデル: Duck -->
            <a-entity
                id="model-duck"
                gltf-model="#duck-model"
                scale="0.4 0.4 0.4"
                position="0 0.25 0"
                visible="true"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 9000; easing: linear"
            ></a-entity>

            <!-- 3Dモデル: Suimon（Hiroマーカー上では 1/1000 スケール） -->
            <a-entity
                id="model-suimon"
                gltf-model="#suimon-model"
                scale="0.00045 0.00045 0.00045"
                position="0 0.25 0"
                rotation="0 30 0"
                visible="false"
                animation="property: rotation; to: 0 -360 0; loop: true; dur: 11000; easing: linear"
            ></a-entity>

            <!-- 3Dモデル: Wankosoba -->
            <a-entity
                id="model-wanko"
                gltf-model="#wanko-model"
                scale="0.35 0.35 0.35"
                position="0 0.25 0"
                visible="false"
                animation="property: position; to: 0 0.6 0; dir: alternate; loop: true; dur: 1600; easing: easeInOutQuad"
            ></a-entity>

            <!-- テキストラベル -->
            <a-text 
                value="Duck / Suimon / Wankosoba" 
                position="0 2 0" 
                align="center" 
                color="#FFFFFF"
                scale="1.2 1.2 1.2"
            ></a-text>
        </a-marker>

        <!-- カメラ -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        function goBack() {
            window.location.href = 'index.html';
        }

        // 「開始」ボタンでユーザー操作をトリガーし、モバイルでのカメラ起動互換性を高める
        (function setupStartOverlay(){
            const overlay = document.getElementById('start-overlay');
            const btn = document.getElementById('start-btn');
            if (!overlay || !btn) return;
            const start = () => {
                overlay.style.display = 'none';
                // iOS/Safari 向けにユーザー操作直後にオーディオ/ビデオ系のロックを外す
                const sceneEl = document.querySelector('a-scene');
                if (sceneEl && sceneEl.components && sceneEl.components['arjs']) {
                    try {
                        // AR.js が内部で getUserMedia を再試行できるように small hack
                        sceneEl.emit('arjs-start');
                    } catch (e) {
                        console.warn('AR.js start emit failed', e);
                    }
                }
            };
            btn.addEventListener('click', start, { once: true });
        })();

        // マーカーが見つかった/見失った時にログを出力
        AFRAME.registerComponent('marker-listener', {
            init: function() {
                this.el.addEventListener('markerFound', function() {
                    console.log('マーカーが見つかりました！');
                    const overlay = document.querySelector('.info-overlay');
                    if (overlay) {
                        overlay.innerHTML = '<p>✓ マーカーを検出しました！ARコンテンツが表示されています</p>';
                    }
                });

                this.el.addEventListener('markerLost', function() {
                    console.log('マーカーが見失われました！');
                    const overlay = document.querySelector('.info-overlay');
                    if (overlay) {
                        overlay.innerHTML = '<p>カメラでHiroマーカーをスキャンしてください</p>';
                    }
                });
            }
        });

        // シーンが読み込まれた後にマーカーにリスナー・モデル切替を追加
        window.addEventListener('load', function() {
            const marker = document.querySelector('a-marker');
            if (marker) {
                marker.setAttribute('marker-listener', '');
            }

            const duck  = document.getElementById('model-duck');
            const suimon = document.getElementById('model-suimon');
            const wanko = document.getElementById('model-wanko');
            const buttons = document.querySelectorAll('#model-switcher button');

            function setActive(model) {
                if (!duck || !suimon || !wanko) return;
                duck.setAttribute('visible', model === 'duck');
                suimon.setAttribute('visible', model === 'suimon');
                wanko.setAttribute('visible', model === 'wanko');
                buttons.forEach((btn) => {
                    const b = btn;
                    const isActive = b.getAttribute('data-model') === model;
                    b.style.opacity = isActive ? '1' : '0.6';
                    b.style.outline = isActive ? '2px solid rgba(255,255,255,0.9)' : 'none';
                });
            }

            setActive('duck');

            buttons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    const model = btn.getAttribute('data-model');
                    if (model === 'duck' || model === 'suimon' || model === 'wanko') {
                        setActive(model);
                    }
                });
            });
        });

        console.log('マーカーベースARが初期化されました');
    </script>
</body>
</html>
